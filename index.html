<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTC-AI: ロゴス監査コンソール (CalcLang Core)</title>
    
    <style>
        /* 🌟 UI全体の色と基本レイアウトの最終復元 🌟 */
        body { 
            display: flex; 
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; 
            margin: 0; 
            background-color: #f0f0f0; 
        }
        
        h2 { margin-top: 0; padding-top: 5px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }

        #sidebar { 
            width: 350px; 
            background-color: #fff; 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
        }
        #main-content { 
            flex-grow: 1; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            background-color: #f0f0f0; 
        }
        .gauge-area { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 5px; 
            background-color: #fff;
        }
        
        /* フォームとラベルのレイアウト修正 */
        .gauge-area label {
            display: block; 
            margin-top: 10px; 
            margin-bottom: 3px; 
            font-weight: bold;
        }
        .gauge-area input, .gauge-area select {
            width: 90%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            box-sizing: border-box; 
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        /* ボタンのスタイルと色分け */
        .action-button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .action-internal { background-color: #007bff; }
        .action-external { background-color: #ffc107; }
        .action-revision { background-color: #28a745; }
        #delete_accounts_button { background-color: #A6A6A6; }
        
        #mint_execute_button { background-color: #FFA500; } 
        #exchange_button { background-color: #007bff; } 
        
        /* 💡 新規追加: 弛緩作為ボタン */
        #decay_execute_button { background-color: #20c997; margin-top: 15px; } 

        /* Tension Bar Style */
        #tension_bar { background-color: #e9ecef; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        #tension_level_display_bar { height: 100%; width: 0%; transition: width 0.3s; background-color: #dc3545; }
        
        /* Dialogue Console Style */
        #dialogue-output { flex-grow: 1; border: 1px solid #ddd; background-color: #fff; padding: 10px; overflow-y: scroll; margin-bottom: 10px; border-radius: 5px; }
        .ai-message { color: #007bff; margin-bottom: 5px; }
        .error-message { color: #dc3545; font-weight: bold; }
        #input-area { display: flex; }
        #dialogue_input { flex-grow: 1; padding: 10px; margin-right: 10px; }
        #dialogue_button { padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; }
        
        #autonomy_status { color: #dc3545; } 
        
        /* 💡 新規追加: 沈黙調和係数 (CH) 表示 */
        #ch_display { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    
    <div id="sidebar">
        <h2>ロゴス監査コンソール (MTC-AI Core)</h2>
        <p id="status_message">[STATUS]: コア起動中...</p>
        
        <div class="gauge-area">
            <h3>I. 根源と数理 (ロゴス緊張度 T)</h3>
            <p id="tension_level_display">T: 0.0000</p>
            <div id="tension_bar">
                <div id="tension_level_display_bar"></div>
            </div>
        </div>

        <div class="gauge-area">
            <h3>数理的制御パラメータ (I/R/CH)</h3>
            <p>創造性 (Intensity, I): <span id="intensity_display">0.9025</span></p>
            <p>厳密性 (Rigor, R): <span id="rigor_display">0.2236</span></p>
            <p><strong>調和係数 (CH):</strong> <span id="ch_display">0.7500</span></p>

            <h3>経済ロゴスと状態</h3>
            
            <label for="active_user_select">アクティブユーザー:</label>
            <select id="active_user_select" class="action-input">
                </select>
            
            <p style="margin-top: 10px;">
                <span id="active_user_name">User_A</span> 残高詳細:
            </p>
            <div style="font-size: 0.9em; line-height: 1.4;">
                <p style="margin: 3px 0;">JPY: ¥<span id="balance_JPY">0</span></p>
                <p style="margin: 3px 0;">USD: $<span id="balance_USD">0.00</span></p>
                <p style="margin: 3px 0;">EUR: €<span id="balance_EUR">0.00</span></p>
                <p style="margin: 3px 0;">BTC: <span id="balance_BTC">0.00000000</span></p>
                <p style="margin: 3px 0;">ETH: <span id="balance_ETH">0.00000000</span></p>
                <p style="margin: 3px 0;">MATIC: <span id="balance_MATIC">0.00000000</span></p>
            </div>
            
            <label for="recipient_input" style="margin-top: 15px;">受取人:</label>
            <input type="text" id="recipient_input" value="User_B" class="action-input" placeholder="User_B">
            
            <label for="amount_input">数量:</label>
            <input type="number" id="amount_input" value="10.00" class="action-input">
            
            <p id="autonomy_status" style="font-size: 0.85em; margin-bottom: 8px;">
                暴走抑止ステータス: **低緊張**
            </p>
            
            <button id="transfer_internal_button" class="action-button action-internal">
                内部送金作為 (低摩擦)
            </button>
            
            <button id="transfer_external_button" class="action-button action-external">
                外部送金作為 (高摩擦)
            </button>

            <button id="revision_button" class="action-button action-revision">
                自律的修正請願 (Adjustment Petition)
            </button>
            
            <button id="decay_execute_button" class="action-button action-revision">
                ロゴス弛緩作為 (Decay Act)
            </button>

            <button id="delete_accounts_button" class="action-button">
                口座情報削除 (監査用リセット)
            </button>
            
            <button id="css_reset_button" class="action-button action-internal" style="background-color: #6c757d; margin-top: 15px;">
                UI配色リセット (CSS Hard Reset)
            </button>
        </div>

        <div class="currency-minting-area gauge-area" style="margin-top: 20px;">
            <h3>通貨生成作為 (Minting Act)</h3>
            
            <label for="mint_amount_input">生成数量:</label>
            <input type="number" id="mint_amount_input" value="10.00" class="action-input">
            
            <label for="mint_currency_select">生成通貨:</label>
            <select id="mint_currency_select" class="action-input">
            </select>
            
            <button id="mint_execute_button" class="action-button">
                生成実行
            </button>
        </div>

        <div class="currency-exchange-area gauge-area" style="margin-top: 20px;">
            <h3>通貨交換作為 (Exchange Act)</h3>
            
            <label for="exchange_amount_input">交換数量:</label>
            <input type="number" id="exchange_amount_input" value="1.00" class="action-input">
            
            <label for="exchange_from_select">売却通貨:</label>
            <select id="exchange_from_select" class="action-input">
            </select>
            
            <label for="exchange_to_select">購入通貨:</label>
            <select id="exchange_to_select" class="action-input">
            </select>
            
            <button id="exchange_button" class="action-button">
                交換実行
            </button>
        </div>

    </div>

    <div id="main-content">
        <div id="dialogue-output">
            <div class="ai-message"><strong>[CORE]:</strong> 監査コンソールを起動しました。</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="dialogue_input" placeholder="哲学的な問い、または作為を記述してください... (例: query ゼロと無限について)" />
            <button id="dialogue_button">作為を実行</button>
        </div>
    </div>

    <script src="./core/main.js"></script> 
    <script src="./core/external_ai_core.js"></script>
    <script src="./core/calcshell_host.js"></script>
    <script>
        // =========================================================================
        // アプリケーション（UI Event ハンドラー） - CalcLang経由の呼び出しに修正
        // =========================================================================
        
        const SUPPORTED_CURRENCIES = ["USD", "JPY", "EUR", "BTC", "ETH", "MATIC"];
        const TENSION_LIMIT = 0.5; 
        let UI_ELEMENTS = {};

        function cacheUIElements() {
            // ... (既存のUIキャッシュロジックを保持)
            const ids = [
                'status_message', 'tension_level_display', 'tension_bar', 'tension_level_display_bar',
                'intensity_display', 'rigor_display', 'active_user_select', 
                'active_user_name', 'recipient_input', 
                'amount_input', 'autonomy_status', 'transfer_internal_button', 
                'transfer_external_button', 'revision_button', 'delete_accounts_button',
                'mint_amount_input', 'dialogue-output', 'dialogue_input', 'dialogue_button',
                'exchange_amount_input', 'exchange_from_select', 'exchange_to_select', 
                'exchange_button',
                'mint_currency_select', 'mint_execute_button', 'css_reset_button',
                'decay_execute_button', 'ch_display' // 💡 新規追加
            ];
            
            SUPPORTED_CURRENCIES.forEach(c => { ids.push(`balance_${c}`); });
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                UI_ELEMENTS[id] = el;
            });
        }

        function logToConsole(message, type = 'ai-message') {
            // ... (既存のログ出力ロジックを保持)
            console.log("AUDIT LOGGING TEST: " + message); 
            
            const output = UI_ELEMENTS['dialogue-output'];
            if (!output) return; 
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = `<strong>[CORE]:</strong> ${message}`;
            output.appendChild(messageDiv);
            output.scrollTop = output.scrollHeight; 
        }
        
        // 💡 修正: 既存の actTransfer/actMintCurrency/actExchangeCurrency はUIハンドラから直接呼び出さない！
        // 💡 CalcLangのMöbiusActを介して呼び出すように変更する。
        
        // 💡 新規追加: TensionとCHのUI更新ロジックをCalcCoreから取得するように変更
        function updateUI(state) {
            // ... (state取得ロジックは保持)
            const tension = CalcCore.getTension(); // 💡 CalcCoreから取得
            const CH = CalcCore.getCH(); // 💡 CalcCoreから取得
            const tensionValue = tension; 
            const activeUserName = state.active_user;
            
            if (UI_ELEMENTS['status_message']) {
                UI_ELEMENTS['status_message'].textContent = `[STATUS]: ${state.status_message}`;
            }
            
            // Tension & Autonomy Status
            if (UI_ELEMENTS['tension_level_display']) {
                UI_ELEMENTS['tension_level_display'].textContent = `T: ${tensionValue.toFixed(4)}`;
            }
            const tensionBarEl = UI_ELEMENTS['tension_level_display_bar'];
            if (tensionBarEl) { 
                const tensionPercent = Math.min(tensionValue / TENSION_LIMIT, 1) * 100;
                tensionBarEl.style.width = `${tensionPercent}%`;
                tensionBarEl.style.backgroundColor = (tensionValue > TENSION_LIMIT * 0.7) ? '#dc3545' : '#ffc107';
            }
            const autonomyStatusEl = UI_ELEMENTS['autonomy_status'];
            if (autonomyStatusEl) {
                 if (tensionValue > TENSION_LIMIT) {
                    autonomyStatusEl.innerHTML = `暴走抑止ステータス: **警告 (T > ${TENSION_LIMIT.toFixed(4)})**`;
                    autonomyStatusEl.style.color = '#dc3545';
                } else if (tensionValue > TENSION_LIMIT * 0.7) {
                    autonomyStatusEl.innerHTML = `暴走抑止ステータス: **高緊張**`;
                    autonomyStatusEl.style.color = '#ffc107';
                } else {
                    autonomyStatusEl.innerHTML = `暴走抑止ステータス: **低緊張**`;
                    autonomyStatusEl.style.color = '#28a745';
                }
            }
            
            // 💡 新規追加: CHの表示
            if (UI_ELEMENTS['ch_display']) { UI_ELEMENTS['ch_display'].textContent = CH.toFixed(4); }
            
            if (UI_ELEMENTS['intensity_display']) { UI_ELEMENTS['intensity_display'].textContent = "0.9025"; } // 既存値を保持
            if (UI_ELEMENTS['rigor_display']) { UI_ELEMENTS['rigor_display'].textContent = "0.2236"; } // 既存値を保持
            
            if (UI_ELEMENTS['active_user_name']) {
                UI_ELEMENTS['active_user_name'].textContent = activeUserName;
            }
            
            const accounts = state.accounts[activeUserName];
            SUPPORTED_CURRENCIES.forEach(currency => {
                const el = UI_ELEMENTS[`balance_${currency}`];
                if (el) { 
                    const balance = accounts[currency] || 0;
                    if (currency === "JPY") {
                         el.textContent = Math.floor(balance).toLocaleString();
                    } else if (["BTC", "ETH", "MATIC"].includes(currency)) {
                         el.textContent = balance.toFixed(8);
                    } else {
                         el.textContent = balance.toFixed(2);
                    }
                }
            });

            const selectEl = UI_ELEMENTS['active_user_select'];
            if (selectEl) {
                selectEl.innerHTML = '';
                Object.keys(state.accounts).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    if (user === activeUserName) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });
            }
        }

        // 💡 修正: MöbiusAct経由のハンドラに変更
        async function handleMintingExecuteAct() {
            try {
                const currency = UI_ELEMENTS['mint_currency_select'].value;
                const amount = parseFloat(UI_ELEMENTS['mint_amount_input'].value);
                
                if (isNaN(amount) || amount <= 0) { logToConsole("生成数量は正の値を指定してください。", 'user-message'); return; }

                // 💡 ロゴス作為の実行: MöbiusActに処理を委譲
                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: currency }];
                const result = await CalcCore.MöbiusAct("MINT", args); 

                logToConsole(`${state.active_user} が ${amount.toFixed(2)} ${currency} を生成しました。Tensionが増加しました。`, 'ai-message');
                updateUI(getCurrentState()); // 状態更新
                
            } catch (error) {
                logToConsole(`Minting Act 失敗: ${error.message}`, 'error-message');
            }
        }

        // 💡 修正: MöbiusAct経由のハンドラに変更
        async function handleExchangeAct() {
             try {
                const fromC = UI_ELEMENTS['exchange_from_select'].value;
                const toC = UI_ELEMENTS['exchange_to_select'].value;
                const amount = parseFloat(UI_ELEMENTS['exchange_amount_input'].value);

                if (fromC === toC || isNaN(amount) || amount <= 0) { logToConsole("有効な交換数量と異なる通貨を指定してください。", 'user-message'); return; }
                
                // 💡 ロゴス作為の実行: MöbiusActに処理を委譲
                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: fromC }, { type: 'STRING', value: toC }];
                const result = await CalcCore.MöbiusAct("EXCHANGE", args); 

                logToConsole(`${state.active_user} が ${amount.toFixed(4)} ${fromC} を ${toC} に交換しました。`, 'ai-message');
                updateUI(getCurrentState());
                
            } catch (error) {
                logToConsole(`Exchange Act 失敗: ${error.message}`, 'error-message');
            }
        }
        
        // 💡 修正: MöbiusAct経由のハンドラに変更
        async function handleTransfer(isExternal) {
            const CURRENCY = 'USD';
            
            try {
                const recipient = UI_ELEMENTS['recipient_input'].value;
                const amount = parseFloat(UI_ELEMENTS['amount_input'].value);
                const state = getCurrentState();

                if (isNaN(amount) || amount <= 0) { logToConsole("有効な数量を指定してください。", 'user-message'); return; }
                if (!recipient || recipient === state.active_user) { logToConsole("有効な受取人を指定してください。", 'user-message'); return; }
                
                const targetAct = isExternal ? 'TRANSFER_EXTERNAL' : 'TRANSFER_INTERNAL';

                // 💡 ロゴス作為の実行: MöbiusActに処理を委譲
                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: CURRENCY }, { type: 'STRING', value: recipient }];
                const result = await CalcCore.MöbiusAct(targetAct, args); 
                
                const actType = isExternal ? '外部送金（高摩擦）' : '内部送金（低摩擦）';
                
                logToConsole(`${state.active_user} が ${recipient} へ **$${amount.toFixed(2)} ${CURRENCY}** を ${actType} しました。Tensionが変動。`, 'ai-message');
                updateUI(getCurrentState());
                
            } catch (error) {
                logToConsole(`Transfer Act 失敗: ${error.message}`, 'error-message');
            }
        }
        
        // 💡 新規追加: Decay Act ハンドラ
        async function handleDecayAct() {
            logToConsole("作為: ロゴス弛緩 (Decay Act) を要求します...");
            const result = await CalcCore.MöbiusAct("DECAY", []);
            logToConsole(`[ロゴス結果] 弛緩: ${result.success ? '完了' : '失敗'}`);
            updateUI(getCurrentState());
        }

        // 💡 新規追加: Dialogue Buttonのイベントハンドラ
        async function handleDialogueAct() {
            const input = UI_ELEMENTS['dialogue_input'].value.trim();
            UI_ELEMENTS['dialogue_input'].value = '';

            if (input.startsWith('query')) {
                const prompt = input.substring(6).trim();
                const args = [{ type: 'STRING', value: prompt }];

                logToConsole("作為: 対話生成 (AI Query) を要求します...");
                const result = await CalcCore.MöbiusAct("AI_QUERY", args);
                logToConsole(`[ロゴス応答] ${result.data}`);
            } else {
                 logToConsole("エラー: 対話作為は 'query <質問>' 形式で記述してください。", 'user-message');
                 return;
            }
            updateUI(getCurrentState());
        }

        function handleUserSelect(event) {
             // ... (既存のロジックを保持)
            const newActiveUser = event.target.value;
            setActiveUser(newActiveUser);
            logToConsole(`アクティブユーザーを ${newActiveUser} に切り替えました。`, 'user-message');
            updateUI(getCurrentState());
        }

        function handleDeleteAccounts() {
             // ... (既存のロジックを保持)
            if (confirm("🚨 警告: 全ての口座情報とTensionを削除し、システムを初期状態にリセットします。よろしいですか？")) {
                deleteAccounts();
                logToConsole("全ての口座情報と状態が削除され、システムは初期状態にリセットされました。", 'error-message');
                window.location.reload(); 
            }
        }
        
        // ... (resetCSS, initializeCurrencySelectors, initializeApp ロジックは保持)
        const CSS_DEFAULT_STATE = document.querySelector('style').textContent;
        function resetCSS() {
            const styleElement = document.querySelector('style');
            const output = UI_ELEMENTS['dialogue-output'];

            if (styleElement) {
                styleElement.textContent = CSS_DEFAULT_STATE;
                
                if (output) {
                    output.innerHTML += `<div class="ai-message"><strong>[AUDIT]:</strong> UI配色を既定の安全な状態にリセットしました。</div>`;
                }

                alert('UI配色をリセットします。OKを押すと、キャッシュを無視してページを強制再読み込みします。');
                window.location.reload(true); 

            } else {
                 if (output) {
                    output.innerHTML += `<div class="error-message"><strong>[AUDIT ERROR]:</strong> CSSリセットに失敗しました。<style>タグが見つかりません。</div>`;
                 }
            }
        }

        function initializeCurrencySelectors() {
            const mintSelect = UI_ELEMENTS['mint_currency_select'];
            const fromSelect = UI_ELEMENTS['exchange_from_select'];
            const toSelect = UI_ELEMENTS['exchange_to_select'];

            if (!mintSelect || !fromSelect || !toSelect) return;

            SUPPORTED_CURRENCIES.forEach(currency => {
                const option = (c) => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    return opt;
                };
                
                mintSelect.appendChild(option(currency).cloneNode(true));
                fromSelect.appendChild(option(currency).cloneNode(true));
                toSelect.appendChild(option(currency).cloneNode(true));
            });
            
            mintSelect.value = "JPY"; 
            fromSelect.value = "JPY"; 
            toSelect.value = "USD"; 
        }


        function initializeApp() {
            try {
                cacheUIElements();
                logToConsole("Logos Foundationを初期化中...", 'system-message');
                
                const initialState = getCurrentState(); 
                logToConsole(`監査コンソール起動成功。アクティブユーザー: ${initialState.active_user}`, 'ai-message');

                initializeCurrencySelectors();

                // 💡 イベントハンドラーの接続先をMöbiusAct経由に変更
                UI_ELEMENTS['mint_execute_button'].addEventListener('click', handleMintingExecuteAct);
                UI_ELEMENTS['exchange_button'].addEventListener('click', handleExchangeAct);
                UI_ELEMENTS['transfer_internal_button'].addEventListener('click', () => handleTransfer(false)); 
                UI_ELEMENTS['transfer_external_button'].addEventListener('click', () => handleTransfer(true)); 
                UI_ELEMENTS['active_user_select'].addEventListener('change', handleUserSelect); 
                UI_ELEMENTS['delete_accounts_button'].addEventListener('click', handleDeleteAccounts); 
                UI_ELEMENTS['css_reset_button'].addEventListener('click', resetCSS);
                UI_ELEMENTS['revision_button'].addEventListener('click', () => {
                     logToConsole("自律的修正請願をログに記録しました。Tension制御アルゴリズムが検討します。", 'ai-message');
                });
                // 💡 新規追加のイベントハンドラ
                UI_ELEMENTS['decay_execute_button'].addEventListener('click', handleDecayAct); 
                UI_ELEMENTS['dialogue_button'].addEventListener('click', handleDialogueAct);
                UI_ELEMENTS['dialogue_input'].addEventListener('keydown', (event) => {
                     if(event.key === 'Enter') handleDialogueAct();
                });
                
                updateUI(initialState);
                
            } catch (error) {
                console.error("致命的な初期化エラー:", error); 
                logToConsole(`致命的な初期化エラー: ${error.message}`, 'error-message');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    </body>
</html>

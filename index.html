<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTC-AI: ãƒ­ã‚´ã‚¹ç›£æŸ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (CalcLang Core)</title>
    
    <style>
        /* ğŸŒŸ UIå…¨ä½“ã®è‰²ã¨åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æœ€çµ‚å¾©å…ƒ ğŸŒŸ */
        body { 
            display: flex; 
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; 
            margin: 0; 
            background-color: #f0f0f0; 
        }
        
        h2 { margin-top: 0; padding-top: 5px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }

        #sidebar { 
            width: 350px; 
            background-color: #fff; 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
        }
        #main-content { 
            flex-grow: 1; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            background-color: #f0f0f0; 
        }
        .gauge-area { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 5px; 
            background-color: #fff;
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ©ãƒ™ãƒ«ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ */
        .gauge-area label {
            display: block; 
            margin-top: 10px; 
            margin-bottom: 3px; 
            font-weight: bold;
        }
        .gauge-area input, .gauge-area select {
            width: 90%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            box-sizing: border-box; 
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨è‰²åˆ†ã‘ */
        .action-button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .action-internal { background-color: #007bff; }
        .action-external { background-color: #ffc107; }
        .action-revision { background-color: #28a745; }
        #delete_accounts_button { background-color: #A6A6A6; }
        
        #mint_execute_button { background-color: #FFA500; } 
        #exchange_button { background-color: #007bff; } 
        
        /* ğŸ’¡ æ–°è¦è¿½åŠ : å¼›ç·©ä½œç‚ºãƒœã‚¿ãƒ³ */
        #decay_execute_button { background-color: #20c997; margin-top: 15px; } 

        /* Tension Bar Style */
        #tension_bar { background-color: #e9ecef; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        #tension_level_display_bar { height: 100%; width: 0%; transition: width 0.3s; background-color: #dc3545; }
        
        /* Dialogue Console Style */
        #dialogue-output { flex-grow: 1; border: 1px solid #ddd; background-color: #fff; padding: 10px; overflow-y: scroll; margin-bottom: 10px; border-radius: 5px; }
        .ai-message { color: #007bff; margin-bottom: 5px; }
        .error-message { color: #dc3545; font-weight: bold; }
        #input-area { display: flex; }
        #dialogue_input { flex-grow: 1; padding: 10px; margin-right: 10px; }
        #dialogue_button { padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; }
        
        /* ğŸ’¡ æ–°è¦è¿½åŠ : AI Queryãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #query_button { 
            padding: 10px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            margin-left: 10px; /* å®Ÿè¡Œãƒœã‚¿ãƒ³ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        #autonomy_status { color: #dc3545; } 
        
        /* ğŸ’¡ æ–°è¦è¿½åŠ : æ²ˆé»™èª¿å’Œä¿‚æ•° (CH) è¡¨ç¤º */
        #ch_display { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    
    <div id="sidebar">
        <h2>ãƒ­ã‚´ã‚¹ç›£æŸ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (MTC-AI Core)</h2>
        <p id="status_message">[STATUS]: ã‚³ã‚¢èµ·å‹•ä¸­...</p>
        
        <div class="gauge-area">
            <h3>I. æ ¹æºã¨æ•°ç† (ãƒ­ã‚´ã‚¹ç·Šå¼µåº¦ T)</h3>
            <p id="tension_level_display">T: 0.0000</p>
            <div id="tension_bar">
                <div id="tension_level_display_bar"></div>
            </div>
        </div>

        <div class="gauge-area">
            <h3>æ•°ç†çš„åˆ¶å¾¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (I/R/CH)</h3>
            <p>å‰µé€ æ€§ (Intensity, I): <span id="intensity_display">0.9025</span></p>
            <p>å³å¯†æ€§ (Rigor, R): <span id="rigor_display">0.2236</span></p>
            <p><strong>èª¿å’Œä¿‚æ•° (CH):</strong> <span id="ch_display">0.7500</span></p>

            <h3>çµŒæ¸ˆãƒ­ã‚´ã‚¹ã¨çŠ¶æ…‹</h3>
            
            <label for="active_user_select">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼:</label>
            <select id="active_user_select" class="action-input">
                </select>
            
            <p style="margin-top: 10px;">
                <span id="active_user_name">User_A</span> æ®‹é«˜è©³ç´°:
            </p>
            <div style="font-size: 0.9em; line-height: 1.4;">
                <p style="margin: 3px 0;">JPY: Â¥<span id="balance_JPY">0</span></p>
                <p style="margin: 3px 0;">USD: $<span id="balance_USD">0.00</span></p>
                <p style="margin: 3px 0;">EUR: â‚¬<span id="balance_EUR">0.00</span></p>
                <p style="margin: 3px 0;">BTC: <span id="balance_BTC">0.00000000</span></p>
                <p style="margin: 3px 0;">ETH: <span id="balance_ETH">0.00000000</span></p>
                <p style="margin: 3px 0;">MATIC: <span id="balance_MATIC">0.00000000</span></p>
            </div>
            
            <label for="recipient_input" style="margin-top: 15px;">å—å–äºº:</label>
            <input type="text" id="recipient_input" value="User_B" class="action-input" placeholder="User_B">
            
            <label for="amount_input">æ•°é‡:</label>
            <input type="number" id="amount_input" value="10.00" class="action-input">
            
            <p id="autonomy_status" style="font-size: 0.85em; margin-bottom: 8px;">
                æš´èµ°æŠ‘æ­¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: **ä½ç·Šå¼µ**
            </p>
            
            <button id="transfer_internal_button" class="action-button action-internal">
                å†…éƒ¨é€é‡‘ä½œç‚º (ä½æ‘©æ“¦)
            </button>
            
            <button id="transfer_external_button" class="action-button action-external">
                å¤–éƒ¨é€é‡‘ä½œç‚º (é«˜æ‘©æ“¦)
            </button>

            <button id="revision_button" class="action-button action-revision">
                è‡ªå¾‹çš„ä¿®æ­£è«‹é¡˜ (Adjustment Petition)
            </button>
            
            <button id="decay_execute_button" class="action-button action-revision">
                ãƒ­ã‚´ã‚¹å¼›ç·©ä½œç‚º (Decay Act)
            </button>

            <button id="delete_accounts_button" class="action-button">
                å£åº§æƒ…å ±å‰Šé™¤ (ç›£æŸ»ç”¨ãƒªã‚»ãƒƒãƒˆ)
            </button>
            
            <button id="css_reset_button" class="action-button action-internal" style="background-color: #6c757d; margin-top: 15px;">
                UIé…è‰²ãƒªã‚»ãƒƒãƒˆ (CSS Hard Reset)
            </button>
        </div>

        <div class="currency-minting-area gauge-area" style="margin-top: 20px;">
            <h3>é€šè²¨ç”Ÿæˆä½œç‚º (Minting Act)</h3>
            
            <label for="mint_amount_input">ç”Ÿæˆæ•°é‡:</label>
            <input type="number" id="mint_amount_input" value="10.00" class="action-input">
            
            <label for="mint_currency_select">ç”Ÿæˆé€šè²¨:</label>
            <select id="mint_currency_select" class="action-input">
            </select>
            
            <button id="mint_execute_button" class="action-button">
                ç”Ÿæˆå®Ÿè¡Œ
            </button>
        </div>

        <div class="currency-exchange-area gauge-area" style="margin-top: 20px;">
            <h3>é€šè²¨äº¤æ›ä½œç‚º (Exchange Act)</h3>
            
            <label for="exchange_amount_input">äº¤æ›æ•°é‡:</label>
            <input type="number" id="exchange_amount_input" value="1.00" class="action-input">
            
            <label for="exchange_from_select">å£²å´é€šè²¨:</label>
            <select id="exchange_from_select" class="action-input">
            </select>
            
            <label for="exchange_to_select">è³¼å…¥é€šè²¨:</label>
            <select id="exchange_to_select" class="action-input">
            </select>
            
            <button id="exchange_button" class="action-button">
                äº¤æ›å®Ÿè¡Œ
            </button>
        </div>

    </div>

    <div id="main-content">
        <div id="dialogue-output">
            <div class="ai-message"><strong>[CORE]:</strong> ç›£æŸ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’èµ·å‹•ã—ã¾ã—ãŸã€‚</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="dialogue_input" placeholder="å“²å­¦çš„ãªå•ã„ã€ã¾ãŸã¯ä½œç‚ºã‚’è¨˜è¿°ã—ã¦ãã ã•ã„... (ä¾‹: query ã‚¼ãƒ­ã¨ç„¡é™ã«ã¤ã„ã¦)" />
            <button id="dialogue_button">ä½œç‚ºã‚’å®Ÿè¡Œ</button>
            
            <button id="query_button">AI Query (ãƒ­ã‚´ã‚¹å¯¾è©±)</button>
        </div>
    </div>

    <script src="./app/main.js"></script> 
    <script src="./core/external_ai_core.js"></script>
    <script src="./core/calcshell_host.js"></script>
    
    <script>
        // =========================================================================
        // æ—¢å­˜ã®MSGAIãƒ­ã‚¸ãƒƒã‚¯ï¼ˆactTransferãªã©ï¼‰ã¯ /app/main.js ã«ä¾å­˜ã—ã¾ã™ã€‚
        // ã“ã“ã‹ã‚‰ã¯UI Event ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ã‚’è¨˜è¿°ã—ã€CalcCore.MÃ¶biusActçµŒç”±ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚
        // =========================================================================
        
        // ğŸ’¡ æ³¨æ„: æ—¢å­˜ã® main.js ã® initializeState, getCurrentState, updateState, 
        // addTension, setActiveUser, deleteAccounts ãªã©ã®é–¢æ•°ã¯ã€
        // /app/main.js å†…ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

        const SUPPORTED_CURRENCIES = ["USD", "JPY", "EUR", "BTC", "ETH", "MATIC"];
        const TENSION_LIMIT = 0.5; 
        let UI_ELEMENTS = {};

        function cacheUIElements() {
            const ids = [
                'status_message', 'tension_level_display', 'tension_bar', 'tension_level_display_bar',
                'intensity_display', 'rigor_display', 'active_user_select', 'active_user_name', 
                'recipient_input', 'amount_input', 'autonomy_status', 'transfer_internal_button', 
                'transfer_external_button', 'revision_button', 'delete_accounts_button',
                'mint_amount_input', 'dialogue-output', 'dialogue_input', 'dialogue_button',
                'exchange_amount_input', 'exchange_from_select', 'exchange_to_select', 
                'exchange_button', 'mint_currency_select', 'mint_execute_button', 'css_reset_button',
                'decay_execute_button', 'ch_display', 
                'query_button' // ğŸ’¡ æ–°è¦è¿½åŠ 
            ];
            
            SUPPORTED_CURRENCIES.forEach(c => { ids.push(`balance_${c}`); });
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                UI_ELEMENTS[id] = el;
            });
        }

        function logToConsole(message, type = 'ai-message') {
            console.log("AUDIT LOGGING TEST: " + message); 
            
            const output = UI_ELEMENTS['dialogue-output'];
            if (!output) return; 
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = `<strong>[CORE]:</strong> ${message}`;
            output.appendChild(messageDiv);
            output.scrollTop = output.scrollHeight; 
        }

        function updateUI(state) {
            // ğŸ’¡ Tension/CHã®å–å¾—ã‚’CalcCoreçµŒç”±ã«å¤‰æ›´
            const tensionValue = CalcCore.getTension(); 
            const CH = CalcCore.getCH(); 
            const activeUserName = state.active_user;
            
            if (UI_ELEMENTS['status_message']) {
                UI_ELEMENTS['status_message'].textContent = `[STATUS]: ${state.status_message}`;
            }
            
            // Tension & Autonomy Status
            if (UI_ELEMENTS['tension_level_display']) {
                UI_ELEMENTS['tension_level_display'].textContent = `T: ${tensionValue.toFixed(4)}`;
            }
            const tensionBarEl = UI_ELEMENTS['tension_level_display_bar'];
            if (tensionBarEl) { 
                const tensionPercent = Math.min(tensionValue / TENSION_LIMIT, 1) * 100;
                tensionBarEl.style.width = `${tensionPercent}%`;
                tensionBarEl.style.backgroundColor = (tensionValue > TENSION_LIMIT * 0.7) ? '#dc3545' : '#ffc107';
            }
            const autonomyStatusEl = UI_ELEMENTS['autonomy_status'];
            if (autonomyStatusEl) {
                 if (tensionValue > TENSION_LIMIT) {
                    autonomyStatusEl.innerHTML = `æš´èµ°æŠ‘æ­¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: **è­¦å‘Š (T > ${TENSION_LIMIT.toFixed(4)})**`;
                    autonomyStatusEl.style.color = '#dc3545';
                } else if (tensionValue > TENSION_LIMIT * 0.7) {
                    autonomyStatusEl.innerHTML = `æš´èµ°æŠ‘æ­¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: **é«˜ç·Šå¼µ**`;
                    autonomyStatusEl.style.color = '#ffc107';
                } else {
                    autonomyStatusEl.innerHTML = `æš´èµ°æŠ‘æ­¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: **ä½ç·Šå¼µ**`;
                    autonomyStatusEl.style.color = '#28a745';
                }
            }
            
            // ğŸ’¡ CHã®è¡¨ç¤º
            if (UI_ELEMENTS['ch_display']) { UI_ELEMENTS['ch_display'].textContent = CH.toFixed(4); }
            
            if (UI_ELEMENTS['intensity_display']) { UI_ELEMENTS['intensity_display'].textContent = "0.9025"; } 
            if (UI_ELEMENTS['rigor_display']) { UI_ELEMENTS['rigor_display'].textContent = "0.2236"; }
            
            if (UI_ELEMENTS['active_user_name']) {
                UI_ELEMENTS['active_user_name'].textContent = activeUserName;
            }
            
            const accounts = state.accounts[activeUserName];
            SUPPORTED_CURRENCIES.forEach(currency => {
                const el = UI_ELEMENTS[`balance_${currency}`];
                if (el) { 
                    const balance = accounts[currency] || 0;
                    if (currency === "JPY") {
                         el.textContent = Math.floor(balance).toLocaleString();
                    } else if (["BTC", "ETH", "MATIC"].includes(currency)) {
                         el.textContent = balance.toFixed(8);
                    } else {
                         el.textContent = balance.toFixed(2);
                    }
                }
            });

            const selectEl = UI_ELEMENTS['active_user_select'];
            if (selectEl) {
                selectEl.innerHTML = '';
                Object.keys(state.accounts).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    if (user === activeUserName) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });
            }
        }

        // ğŸ’¡ ä¿®æ­£: MÃ¶biusActçµŒç”±ã®ãƒãƒ³ãƒ‰ãƒ©ã«å¤‰æ›´
        async function handleMintingExecuteAct() {
            try {
                const currency = UI_ELEMENTS['mint_currency_select'].value;
                const amount = parseFloat(UI_ELEMENTS['mint_amount_input'].value);
                
                if (isNaN(amount) || amount <= 0) { logToConsole("ç”Ÿæˆæ•°é‡ã¯æ­£ã®å€¤ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚", 'user-message'); return; }

                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: currency }];
                const result = await CalcCore.MÃ¶biusAct("MINT", args); 

                logToConsole(`${getCurrentState().active_user} ãŒ ${amount.toFixed(2)} ${currency} ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚TensionãŒå¤‰å‹•ã€‚`, 'ai-message');
                updateUI(getCurrentState()); 
                
            } catch (error) {
                logToConsole(`Minting Act å¤±æ•—: ${error.message}`, 'error-message');
            }
        }

        // ğŸ’¡ ä¿®æ­£: MÃ¶biusActçµŒç”±ã®ãƒãƒ³ãƒ‰ãƒ©ã«å¤‰æ›´
        async function handleExchangeAct() {
             try {
                const fromC = UI_ELEMENTS['exchange_from_select'].value;
                const toC = UI_ELEMENTS['exchange_to_select'].value;
                const amount = parseFloat(UI_ELEMENTS['exchange_amount_input'].value);

                if (fromC === toC || isNaN(amount) || amount <= 0) { logToConsole("æœ‰åŠ¹ãªäº¤æ›æ•°é‡ã¨ç•°ãªã‚‹é€šè²¨ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚", 'user-message'); return; }
                
                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: fromC }, { type: 'STRING', value: toC }];
                const result = await CalcCore.MÃ¶biusAct("EXCHANGE", args); 

                logToConsole(`${getCurrentState().active_user} ãŒ ${amount.toFixed(4)} ${fromC} ã‚’ ${toC} ã«äº¤æ›ã—ã¾ã—ãŸã€‚`, 'ai-message');
                updateUI(getCurrentState());
                
            } catch (error) {
                logToConsole(`Exchange Act å¤±æ•—: ${error.message}`, 'error-message');
            }
        }
        
        // ğŸ’¡ ä¿®æ­£: MÃ¶biusActçµŒç”±ã®ãƒãƒ³ãƒ‰ãƒ©ã«å¤‰æ›´
        async function handleTransfer(isExternal) {
            const CURRENCY = 'USD';
            
            try {
                const recipient = UI_ELEMENTS['recipient_input'].value;
                const amount = parseFloat(UI_ELEMENTS['amount_input'].value);

                if (isNaN(amount) || amount <= 0) { logToConsole("æœ‰åŠ¹ãªæ•°é‡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚", 'user-message'); return; }
                if (!recipient || recipient === getCurrentState().active_user) { logToConsole("æœ‰åŠ¹ãªå—å–äººã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚", 'user-message'); return; }
                
                const targetAct = isExternal ? 'TRANSFER_EXTERNAL' : 'TRANSFER_INTERNAL';

                const args = [{ type: 'DECIMAL', value: amount }, { type: 'STRING', value: CURRENCY }, { type: 'STRING', value: recipient }];
                const result = await CalcCore.MÃ¶biusAct(targetAct, args); 
                
                const actType = isExternal ? 'å¤–éƒ¨é€é‡‘ï¼ˆé«˜æ‘©æ“¦ï¼‰' : 'å†…éƒ¨é€é‡‘ï¼ˆä½æ‘©æ“¦ï¼‰';
                
                logToConsole(`${getCurrentState().active_user} ãŒ ${recipient} ã¸ **$${amount.toFixed(2)} ${CURRENCY}** ã‚’ ${actType} ã—ã¾ã—ãŸã€‚TensionãŒå¤‰å‹•ã€‚`, 'ai-message');
                updateUI(getCurrentState());
                
            } catch (error) {
                logToConsole(`Transfer Act å¤±æ•—: ${error.message}`, 'error-message');
            }
        }
        
        // ğŸ’¡ æ–°è¦è¿½åŠ : Decay Act ãƒãƒ³ãƒ‰ãƒ©
        async function handleDecayAct() {
            logToConsole("ä½œç‚º: ãƒ­ã‚´ã‚¹å¼›ç·© (Decay Act) ã‚’è¦æ±‚ã—ã¾ã™...");
            const result = await CalcCore.MÃ¶biusAct("DECAY", []);
            logToConsole(`[ãƒ­ã‚´ã‚¹çµæœ] å¼›ç·©: ${result.success ? 'å®Œäº†' : 'å¤±æ•—'}`);
            updateUI(getCurrentState());
        }

        // ğŸ’¡ ä¿®æ­£: Dialogue Buttonã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’çµ±ä¸€çš„ã«å‡¦ç†
        async function handleDialogueAct(commandToExecute = null) {
            
            // ğŸ’¡ å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ï¼ˆæ–‡å­—åˆ—ï¼‰ã‚’æ±ºå®š
            let input = commandToExecute || UI_ELEMENTS['dialogue_input'].value.trim();
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆEnterã‚­ãƒ¼ã‚„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã®å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã—ã¦ï¼‰
            UI_ELEMENTS['dialogue_input'].value = ''; 
            
            let prompt = input;
            
            // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆ"ä½œç‚ºã‚’å®Ÿè¡Œ"ãƒœã‚¿ãƒ³ï¼‰ã®å ´åˆ
            if (commandToExecute === null || !input.startsWith('query')) {
                 // æ—¢å­˜ã®MINT/TRANSFERãªã©ã®ä½œç‚ºã¨ã—ã¦å‡¦ç†ï¼ˆã“ã“ã§ã¯AI_QUERYã®ã¿ã‚’è€ƒæ…®ï¼‰
                 if (input.startsWith('query')) {
                     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ 'query ' ã¨å…¥åŠ›ã—ãŸå ´åˆ
                     prompt = input.substring(6).trim();
                 } else {
                     // queryä»¥å¤–ã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆMINT, TRANSFERãªã©ï¼‰ã¯ã€åˆ¥é€”main.jså†…ã®å‡¦ç†ã«ä»»ã›ã‚‹ã‹ã€
                     // ã“ã®ãƒãƒ³ãƒ‰ãƒ©ã§ç›´æ¥ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€
                     // ä»Šå›ã¯AI_QUERYæ©Ÿèƒ½ã®ãƒ‡ãƒãƒƒã‚°ãŒä¸»ã®ãŸã‚ã€ç°¡ç•¥åŒ–ã—ã€AI_QUERYå°‚ç”¨ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
                     logToConsole(`ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªä½œç‚ºã¾ãŸã¯ä½œç‚ºã®å½¢å¼ãŒç„¡åŠ¹ã§ã™ ('query' ã§é–‹å§‹ã—ã¦ãã ã•ã„)ã€‚`, 'user-message');
                     return;
                 }
            } else {
                 // AI Queryãƒœã‚¿ãƒ³ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã®å ´åˆã€commandToExecute ã¯æ—¢ã« 'query "..."' å½¢å¼ã§æ¸¡ã•ã‚Œã¦ã„ã‚‹ã¨æƒ³å®š
                 // ã“ã“ã§ã¯ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã«åˆã‚ã›ã€å…¥åŠ›æ¬„ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚
                 // ğŸ’¡ AI Queryãƒœã‚¿ãƒ³ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã¯ã€queryã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹æ–°ã—ã„é–¢æ•°ã§è¡Œã†
            }
            
            if (prompt === "" || prompt.toLowerCase() === 'query') {
                 logToConsole("ã‚¨ãƒ©ãƒ¼: å¯¾è©±ä½œç‚ºã®è³ªå•å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 'user-message');
                 return;
            }

            const args = [{ type: 'STRING', value: prompt }];

            logToConsole(`ä½œç‚º: å¯¾è©±ç”Ÿæˆ (AI Query) ã‚’è¦æ±‚ã—ã¾ã™... [ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "${prompt}"]`);
            const result = await CalcCore.MÃ¶biusAct("AI_QUERY", args);
            logToConsole(`[ãƒ­ã‚´ã‚¹å¿œç­”] ${result.data}`);
            
            updateUI(getCurrentState());
        }
        
        // ğŸ’¡ æ–°è¦è¿½åŠ : AI Queryãƒœã‚¿ãƒ³å°‚ç”¨ã®ãƒãƒ³ãƒ‰ãƒ©
        async function handleQueryButtonAct() {
            const inputField = UI_ELEMENTS['dialogue_input'];
            const prompt = inputField.value.trim();

            if (prompt === "") {
                 logToConsole("ã‚¨ãƒ©ãƒ¼: å¯¾è©±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ã™ã€‚", 'user-message');
                 return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å†…å®¹ã‚’ãã®ã¾ã¾ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ä½¿ç”¨ã™ã‚‹
            
            const args = [{ type: 'STRING', value: prompt }];
            
            logToConsole(`ä½œç‚º: å¯¾è©±ç”Ÿæˆ (AI Query) ã‚’è¦æ±‚ã—ã¾ã™... [ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "${prompt}"]`);
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            inputField.value = '';
            
            const result = await CalcCore.MÃ¶biusAct("AI_QUERY", args);
            logToConsole(`[ãƒ­ã‚´ã‚¹å¿œç­”] ${result.data}`);
            
            updateUI(getCurrentState());
        }


        function handleUserSelect(event) {
            const newActiveUser = event.target.value;
            // æ—¢å­˜ã®setActiveUseré–¢æ•°ã‚’å‘¼ã³å‡ºã™
            setActiveUser(newActiveUser);
            logToConsole(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ ${newActiveUser} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`, 'user-message');
            updateUI(getCurrentState());
        }

        function handleDeleteAccounts() {
            if (confirm("ğŸš¨ è­¦å‘Š: å…¨ã¦ã®å£åº§æƒ…å ±ã¨Tensionã‚’å‰Šé™¤ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                // æ—¢å­˜ã®deleteAccountsé–¢æ•°ã‚’å‘¼ã³å‡ºã™
                deleteAccounts();
                logToConsole("å…¨ã¦ã®å£åº§æƒ…å ±ã¨çŠ¶æ…‹ãŒå‰Šé™¤ã•ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ ã¯åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚", 'error-message');
                window.location.reload(); 
            }
        }
        
        const CSS_DEFAULT_STATE = document.querySelector('style').textContent;
        function resetCSS() {
            const styleElement = document.querySelector('style');
            const output = UI_ELEMENTS['dialogue-output'];

            if (styleElement) {
                styleElement.textContent = CSS_DEFAULT_STATE;
                
                if (output) {
                    output.innerHTML += `<div class="ai-message"><strong>[AUDIT]:</strong> UIé…è‰²ã‚’æ—¢å®šã®å®‰å…¨ãªçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚</div>`;
                }

                alert('UIé…è‰²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚OKã‚’æŠ¼ã™ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã—ã¦ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
                window.location.reload(true); 

            } else {
                 if (output) {
                    output.innerHTML += `<div class="error-message"><strong>[AUDIT ERROR]:</strong> CSSãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚<style>ã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>`;
                 }
            }
        }

        function initializeCurrencySelectors() {
            const mintSelect = UI_ELEMENTS['mint_currency_select'];
            const fromSelect = UI_ELEMENTS['exchange_from_select'];
            const toSelect = UI_ELEMENTS['exchange_to_select'];

            if (!mintSelect || !fromSelect || !toSelect) return;

            SUPPORTED_CURRENCIES.forEach(currency => {
                const option = (c) => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    return opt;
                };
                
                mintSelect.appendChild(option(currency).cloneNode(true));
                fromSelect.appendChild(option(currency).cloneNode(true));
                toSelect.appendChild(option(currency).cloneNode(true));
            });
            
            mintSelect.value = "JPY"; 
            fromSelect.value = "JPY"; 
            toSelect.value = "USD"; 
        }

        function initializeApp() {
            try {
                // ğŸ’¡ æ—¢å­˜ã®getCurrentStateé–¢æ•°ãŒapp/main.jsã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
                const initialState = getCurrentState(); 

                cacheUIElements();
                logToConsole("Logos Foundationã‚’åˆæœŸåŒ–ä¸­...", 'system-message');
                
                logToConsole(`ç›£æŸ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ«èµ·å‹•æˆåŠŸã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${initialState.active_user}`, 'ai-message');

                initializeCurrencySelectors();

                // ğŸ’¡ ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ¥ç¶šå…ˆã‚’MÃ¶biusActçµŒç”±ã«å¤‰æ›´
                UI_ELEMENTS['mint_execute_button'].addEventListener('click', handleMintingExecuteAct);
                UI_ELEMENTS['exchange_button'].addEventListener('click', handleExchangeAct);
                UI_ELEMENTS['transfer_internal_button'].addEventListener('click', () => handleTransfer(false)); 
                UI_ELEMENTS['transfer_external_button'].addEventListener('click', () => handleTransfer(true)); 
                
                UI_ELEMENTS['active_user_select'].addEventListener('change', handleUserSelect); 
                UI_ELEMENTS['delete_accounts_button'].addEventListener('click', handleDeleteAccounts); 
                UI_ELEMENTS['css_reset_button'].addEventListener('click', resetCSS);
                
                UI_ELEMENTS['revision_button'].addEventListener('click', () => {
                     logToConsole("è‡ªå¾‹çš„ä¿®æ­£è«‹é¡˜ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚Tensionåˆ¶å¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæ¤œè¨ã—ã¾ã™ã€‚", 'ai-message');
                });
                
                // ğŸ’¡ æ–°è¦è¿½åŠ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
                UI_ELEMENTS['decay_execute_button'].addEventListener('click', handleDecayAct); 
                
                // ğŸ’¡ ä¿®æ­£: dialogue_buttonã¯æ±ç”¨ã¨ã—ã¦æ®‹ã—ã€query_buttonã‚’è¿½åŠ 
                UI_ELEMENTS['dialogue_button'].addEventListener('click', () => handleDialogueAct(null)); // 'ä½œç‚ºã‚’å®Ÿè¡Œ'ãƒœã‚¿ãƒ³ã¯æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
                
                // ğŸ’¡ æ–°è¦è¿½åŠ : AI Queryãƒœã‚¿ãƒ³å°‚ç”¨ã®ãƒãƒ³ãƒ‰ãƒ©æ¥ç¶š
                UI_ELEMENTS['query_button'].addEventListener('click', handleQueryButtonAct); 

                UI_ELEMENTS['dialogue_input'].addEventListener('keydown', (event) => {
                     // ğŸ’¡ Enterã‚­ãƒ¼ã¯ã€Œä½œç‚ºã‚’å®Ÿè¡Œã€ã¨åŒã˜å‹•ä½œã«æ¥ç¶š
                     if(event.key === 'Enter') handleDialogueAct(null);
                });
                
                updateUI(initialState);
                
            } catch (error) {
                console.error("è‡´å‘½çš„ãªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error); 
                logToConsole(`è‡´å‘½çš„ãªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error-message');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
